# 基于 VirualBox 的网络攻防基础环境搭建

## 实验目的

- 掌握 VirtualBox 虚拟机的安装与使用；
- 掌握 VirtualBox 的虚拟网络类型和按需配置；
- 掌握 VirtualBox 的虚拟硬盘多重加载；

## 实验环境

- VirtualBox 虚拟机
- 攻击者主机（Attacker）：Kali-linux
- 网关（Gateway, GW）：Debian Buster
- 靶机（Victim）：From Sqli to shell / xp-sp3 / Kali

## 实验过程

### 虚拟硬盘配置成多重加载

**Kali配置：**

![](./img/多重加载.png)



**Debian配置：**

![](./img/Debian10配置.png)



**Windows XP配置：**

![](./img/xp配置.png)



### 搭建满足如下拓扑图所示的虚拟机网络拓扑

![](./img/拓扑图.png)

+ 基于上述的虚拟硬盘配置，创建多个虚拟机：

  ![](./img/创建多个虚拟机.png)

+ 配置网关 **Gateway-Debian-1** 的网卡，状态如下：

  | 网卡  | 网络                    | 界面名称                              |
  | ----- | ----------------------- | ------------------------------------- |
  | 网卡1 | NAT网络                 | NatNetwork                            |
  | 网卡2 | 仅主机（Host-Only）网络 | VirtualBox Host-Only Ethernet Adapter |
  | 网卡3 | 内部网络                | intnet0                               |
  | 网卡4 | 内部网络                | intnet1                               |

  ![](./img/网关网卡.png)

  + 查看网关系统文件配置：

    ```
    root@debian:~# vi /etc/network/interfaces
    ```

    ```
    # This file describes the network interfaces available on your system
    # and how to activate them. For more information, see interfaces(5).
    
    source /etc/network/interfaces.d/*
    
    # The loopback network interface
    auto lo
    iface lo inet loopback
    
    # The primary network interface
    allow-hotplug enp0s3
    iface enp0s3 inet dhcp
    allow-hotplug enp0s8
    iface enp0s8 inet dhcp
    allow-hotplug enp0s9
    iface enp0s9 inet static
      address 172.16.111.1
      netmask 255.255.255.0
      post-up echo 1 > /proc/sys/net/ipv4/ip_forward
      post-up   iptables -P FORWARD DROP
      post-up   iptables -t nat -A POSTROUTING -s '172.16.111.0/24' ! -d '172.16.111.0/24' -o enp0s3 -j MASQUERADE
      post-up   iptables -I FORWARD -s '172.16.111.0/24' ! -d '172.16.111.0/24' -i enp0s9 -j ACCEPT
      post-up   iptables -I FORWARD -s '172.16.111.0/24' -d '172.16.222.0/24' -i enp0s9 -j DROP
      post-up   iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
      post-down iptables -t nat -D POSTROUTING -s '172.16.111.0/24' ! -d '172.16.111.0/24' -o enp0s3 -j ACCEPT
      post-down iptables -D FORWARD -s '172.16.111.0/24' ! -d '172.16.111.0/24' -i enp0s9 -j ACCEPT
      post-down iptables -D FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
      post-down iptables -I FORWARD -s '172.16.111.0/24' -d '172.16.222.0/24' -i enp0s9 -j DROP
    allow-hotplug enp0s10
    iface enp0s10 inet static
      address 172.16.222.1
      netmask 255.255.255.0
      post-up   iptables -P FORWARD DROP
      post-up   iptables -t nat -A POSTROUTING -s '172.16.222.0/24' ! -d '172.16.222.0/24' -o enp0s3 -j MASQUERADE
      post-up   iptables -I FORWARD -s '172.16.222.0/24' ! -d '172.16.222.0/24' -i enp0s10 -j ACCEPT
      post-up   iptables -I FORWARD -s '172.16.222.0/24' -d '172.16.111.0/24' -i enp0s10 -j DROP
      post-down iptables -t nat -D POSTROUTING -s '172.16.222.0/24' ! -d '172.16.222.0/24' -o enp0s3 -j MASQUERADE
      post-down iptables -D FORWARD -s '172.16.222.0/24' ! -d '172.16.222.0/24' -i enp0s10 -j ACCEPT
    ```

    这里看到系统文件已经配置好了，之后可以直接测试连通性。

    ![](./img/网关网络地址.png)

+ 配置四台靶机的网卡，状态如下：

  |                    | 主机名称        | 网卡设置         |
  | ------------------ | --------------- | ---------------- |
  | 局域网 **intnet0** | Victim-winxp-1  | 内部网络 intnet0 |
  |                    | Victim-Kali-1   | 内部网络 intnet0 |
  | 局域网 **intnet1** | Victim-winxp-2  | 内部网络 intnet1 |
  |                    | Victim-Debian-2 | 内部网络 intnet1 |

+ 配置攻击者主机即 **attacter-kali-linux**，状态如下：

  | 网卡  | 网络                    | 界面名称                              |
  | ----- | ----------------------- | ------------------------------------- |
  | 网卡1 | NAT网络                 | NatNetwork                            |
  | 网卡2 | 仅主机（Host-Only）网络 | VirtualBox Host-Only Ethernet Adapter |
  | 网卡3 | 仅主机（Host-Only）网络 | VirtualBox Host-Only Ethernet Adapter |

  ![](./img/攻击者网卡.png)

+ 查看各主机的 `IP` 地址

  ```
  #查看WindowsXP的地址
  ipconfig 
  
  #查看Kali的地址
  ip addr show
  
  #查看Debian的地址
  ip add
  ```

  **攻击者主机 （kali)：**

  ![](./img/attacker网络地址.png)

  

  **XP靶机1：**

  ![](./img/xp1网络地址.png)

  

  **XP靶机2：**

  ![](./img/xp2网络地址.png)

  

  **kali靶机：**

  ![](./img/Victim-Kali网络地址.png)

  

  **Debian靶机：**

  ![](./img/Victim-Debian-2网络地址.png)

  | 主机名称            | IP地址         | 默认网关     |
  | ------------------- | -------------- | ------------ |
  | attacter-kali-linux | 10.0.2.15      | 无           |
  | Victim-winxp-1      | 172.16.111.144 | 172.16.111.1 |
  | Victim-winxp-2      | 172.16.222.136 | 172.16.222.1 |
  | Victim-Kali-1       | 172.16.111.107 | 172.16.111.1 |
  | Victim-Debian-2     | 172.16.222.109 | 172.16.222.1 |


### 完成以下网络连通性测试：

- [x] 靶机可以直接访问攻击者主机

  **Victim-winxp-1** 访问攻击者主机：

  ![](./img/xp1-att.png)

  **Victim-winxp-2** 访问攻击者主机：

  ![](./img/xp2-att.png)

  **Victim-Kali-1** 访问攻击者主机：

  ![](./img/kali-att.png)

  **Victim-Debian-2** 访问攻击者主机：

  ![](./img/debian2-att.png)

  

- [x] 攻击者主机无法直接访问靶机

  ![](./img/攻击者主机无法直接访问靶机.png)

- [x] 网关可以直接访问攻击者主机和靶机

  ![](./img/网关可以访问各个主机.png)

- [x] 靶机的所有对外上下行流量必须经过网关 (以靶机 `Victim-winxp-2` 为例)

  + 在本地命令行 `ssh` 登录网关主机 `Gateway-Debian-1`，并开启 `wireshark` 进行抓包

  + 在虚拟机 `Victim-winxp-2` 内进行 `ping www.baidu.com`

  + 停止抓包，并过滤 `ip.addr == 110.242.68.3` 的包，发现确实流经网关。

    ![](./img/靶机所有流量流经网关.png)

- [x] 所有节点均可以访问互联网

  **攻击者访问百度：**

  ![](./img/攻击者访问百度.png)

  **xp1访问百度：**

  ![](./img/XP1访问百度.png)

  **xp2访问百度：**

  ![](./img/XP2访问百度.png)

  **kali访问百度：**

  ![](./img/kali访问百度.png)

  **debian访问百度：**

  ![](./img/debian访问百度.png)

  **网关访问百度：**

  ![](./img/网关访问百度.png)



## 实验小结

+ 配置多重加载的好处是多个虚拟机可以使用同一个镜像文件。
+ 在第一次启动 `Kali` 的时候就提示要输入用户名和密码才能进入，搜索得知默认用户名和账户密码都是 **kali**，可以根据教程修改成自己的账号和密码。
+ 网关必须开启，靶机才能连接到网络。
+ 关闭 `xp` 系统的防火墙，网关才能成功访问 `xp` 靶机。

## 参考文献

+ [Kali忘记密码重置方法]()

